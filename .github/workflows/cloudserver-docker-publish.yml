name: Build, Push, and Restart Docker Compose

on:
  push:
    branches:
      - main
    paths:
      - 'build/cloudserver/**'

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: amedeopalopoli/devsecopsdemo2025-cloudserver
  IMAGE_TAG: latest

jobs:
  build-push-restart-cloudserver:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker registry
        run: echo $DOCKER_PASSWORD | docker login ${{ env.DOCKER_REGISTRY }} -u $DOCKER_USERNAME --password-stdin

      - name: Build Docker image with docker compose
        run: |
          cd build/cloudserver
          docker-compose build restapi

      - name: Tag custom image
        run: |
          docker tag cloudserver_restapi:latest ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Push Docker image
        run: |
          docker push ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Copy docker-compose.yml to /home/ubuntu
        run: cp build/cloudserver/docker-compose.yml /home/ubuntu/docker-compose.yml

      - name: Restart docker compose
        run: |
          cd /home/ubuntu
          docker-compose down
          docker-compose up -d